# ──────────────────────────────────────────────────────────────────────────
# SCRA – CI/CD Pipeline (GitHub Actions)
#
# Stages:
#   1. Lint + Type Check       (every push/PR)
#   2. Unit Tests              (every push/PR)
#   3. Eval Regression Guard   (on PRs to main, requires API keys)
# ──────────────────────────────────────────────────────────────────────────
name: SCRA CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: "3.11"

jobs:
  # ────────────────────────────────────────────────────────────────────────
  # Stage 1: Lint & Static Analysis
  # ────────────────────────────────────────────────────────────────────────
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install ruff

      - name: Ruff lint
        run: ruff check src/ tests/ evals/

      - name: Ruff format check
        run: ruff format --check src/ tests/ evals/

  # ────────────────────────────────────────────────────────────────────────
  # Stage 2: Unit Tests (no API keys needed)
  # ────────────────────────────────────────────────────────────────────────
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests
        run: |
          pytest tests/ -v --tb=short -x \
            --cov=src --cov-report=term-missing \
            --cov-fail-under=80

      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: .coverage

  # ────────────────────────────────────────────────────────────────────────
  # Stage 3: Eval Regression Guard (PRs to main only)
  #
  # Runs the golden dataset evaluation against the live APIs,
  # compares against the checked-in baseline, and fails the PR
  # if regressions are detected.
  # ────────────────────────────────────────────────────────────────────────
  eval-regression:
    name: Eval Regression Guard
    runs-on: ubuntu-latest
    needs: unit-tests
    if: github.event_name == 'pull_request' && github.base_ref == 'main'
    env:
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
      TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start server
        run: |
          uvicorn src.main:create_app --factory --host 0.0.0.0 --port 8000 &
          sleep 5

      - name: Ingest corpus
        run: |
          curl -sf -X POST http://localhost:8000/ingest --max-time 120

      - name: Run evaluation
        run: |
          python -m evals.run_eval \
            --url http://localhost:8000 \
            --output evals/results/pr_run.json

      - name: Compare against baseline
        if: hashFiles('evals/results/baseline.json') != ''
        run: |
          python -m evals.compare_runs \
            evals/results/baseline.json \
            evals/results/pr_run.json

      - name: Upload eval results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eval-results
          path: evals/results/pr_run.json
